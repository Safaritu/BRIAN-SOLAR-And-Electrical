<binary>
  <!-- 
    Binary Bot for Deriv.com
    Created from third-party bot conversion
    Martingale strategy for Digits Matches/Differs
  -->
  
  <trade
    name="Martingale Digits Bot"
    description="Martingale strategy for R_50 with recovery mode"
    icon="trending_up"
    version="1.0"
  >
  
  <settings>
    <general>
      <duration type="t">1</duration>
      <stake>6</stake>
      <currency>USD</currency>
      <prediction>1</prediction>
      <basis>stake</basis>
    </general>
    
    <symbol>
      <market>synthetic_index</market>
      <submarket>random_index</submarket>
      <symbol>R_50</symbol>
    </symbol>
    
    <contract>
      <type>matchesdiffers</type>
      <category>digits</category>
    </contract>
    
    <trading>
      <max_trades>100</max_trades>
      <restart_on_error>true</restart_on_error>
    </trading>
  </settings>

  <blocks>
    <block type="trade_definition" id="main_trade" x="50" y="50">
      <field name="MARKET_LIST">synthetic_index</field>
      <field name="SUBMARKET_LIST">random_index</field>
      <field name="SYMBOL_LIST">R_50</field>
      <field name="TRADETYPECAT_LIST">digits</field>
      <field name="TRADETYPE_LIST">matchesdiffers</field>
      <field name="TRADE_EACH_TICK">FALSE</field>
      <statement name="INITIALIZATION">
        <block type="variables_set">
          <field name="VAR" id="stake">stake</field>
          <value name="VALUE">
            <block type="math_number">
              <field name="NUM">6</field>
            </block>
          </value>
          <next>
            <block type="variables_set">
              <field name="VAR" id="take_profit">take_profit</field>
              <value name="VALUE">
                <block type="math_number">
                  <field name="NUM">5</field>
                </block>
              </value>
              <next>
                <block type="variables_set">
                  <field name="VAR" id="stop_loss">stop_loss</field>
                  <value name="VALUE">
                    <block type="math_number">
                      <field name="NUM">30</field>
                    </block>
                  </value>
                  <next>
                    <block type="variables_set">
                      <field name="VAR" id="martingale">martingale</field>
                      <value name="VALUE">
                        <block type="math_number">
                          <field name="NUM">2</field>
                        </block>
                      </value>
                      <next>
                        <block type="variables_set">
                          <field name="VAR" id="recovery_mode">recovery_mode</field>
                          <value name="VALUE">
                            <block type="logic_boolean">
                              <field name="BOOL">FALSE</field>
                            </block>
                          </value>
                          <next>
                            <block type="variables_set">
                              <field name="VAR" id="initial_stake">initial_stake</field>
                              <value name="VALUE">
                                <block type="math_number">
                                  <field name="NUM">6</field>
                                </block>
                              </value>
                              <next>
                                <block type="variables_set">
                                  <field name="VAR" id="next_trade">next_trade</field>
                                  <value name="VALUE">
                                    <block type="text">
                                      <field name="TEXT">UNDER</field>
                                    </block>
                                  </value>
                                </block>
                              </next>
                            </block>
                          </next>
                        </block>
                      </next>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
      </statement>
    </block>
    
    <block type="before_purchase" id="before_purchase_block" x="50" y="300">
      <statement name="BEFOREPURCHASE_STACK">
        <block type="controls_if">
          <mutation else="1"></mutation>
          <value name="IF0">
            <block type="logic_compare">
              <field name="OP">EQ</field>
              <value name="A">
                <block type="variables_get">
                  <field name="VAR" id="recovery_mode">recovery_mode</field>
                </block>
              </value>
              <value name="B">
                <block type="logic_boolean">
                  <field name="BOOL">FALSE</field>
                </block>
              </value>
            </block>
          </value>
          <statement name="DO0">
            <!-- Normal Trading Mode -->
            <block type="controls_if">
              <value name="IF0">
                <block type="last_digits_condition">
                  <field name="CONDITION">ALL_SAME</field>
                  <value name="N">
                    <shadow type="math_number">
                      <field name="NUM">2</field>
                    </shadow>
                    <block type="math_number">
                      <field name="NUM">2</field>
                    </block>
                  </value>
                </block>
              </value>
              <statement name="DO0">
                <block type="variables_set">
                  <field name="VAR" id="prediction">prediction</field>
                  <value name="VALUE">
                    <block type="last_digit"></block>
                  </value>
                </block>
              </statement>
              <next>
                <block type="trade_definition_tradeoptions">
                  <field name="DURATIONTYPE_LIST">t</field>
                  <field name="TRADE_EACH_TICK">FALSE</field>
                  <value name="DURATION">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                  </value>
                  <value name="AMOUNT">
                    <shadow type="math_number">
                      <field name="NUM">6</field>
                    </shadow>
                    <block type="variables_get">
                      <field name="VAR" id="stake">stake</field>
                    </block>
                  </value>
                  <value name="PREDICTION">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                    <block type="variables_get">
                      <field name="VAR" id="prediction">prediction</field>
                    </block>
                  </value>
                </block>
              </next>
            </block>
          </statement>
          <statement name="ELSE">
            <!-- Recovery Mode -->
            <block type="controls_if">
              <mutation elseif="1"></mutation>
              <value name="IF0">
                <block type="last_digits_condition">
                  <field name="CONDITION">ALL_EVEN</field>
                  <value name="N">
                    <shadow type="math_number">
                      <field name="NUM">5</field>
                    </shadow>
                    <block type="math_number">
                      <field name="NUM">5</field>
                    </block>
                  </value>
                </block>
              </value>
              <statement name="DO0">
                <block type="trade_definition_tradeoptions">
                  <field name="DURATIONTYPE_LIST">t</field>
                  <field name="TRADE_EACH_TICK">FALSE</field>
                  <field name="TRADETYPE_LIST">digitodd</field>
                  <value name="DURATION">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                  </value>
                  <value name="AMOUNT">
                    <shadow type="math_number">
                      <field name="NUM">6</field>
                    </shadow>
                    <block type="variables_get">
                      <field name="VAR" id="stake">stake</field>
                    </block>
                  </value>
                  <value name="PREDICTION">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                    <block type="math_number">
                      <field name="NUM">1</field>
                    </block>
                  </value>
                </block>
              </statement>
              <value name="IF1">
                <block type="last_digits_condition">
                  <field name="CONDITION">ALL_ODD</field>
                  <value name="N">
                    <shadow type="math_number">
                      <field name="NUM">5</field>
                    </shadow>
                    <block type="math_number">
                      <field name="NUM">5</field>
                    </block>
                  </value>
                </block>
              </value>
              <statement name="DO1">
                <block type="trade_definition_tradeoptions">
                  <field name="DURATIONTYPE_LIST">t</field>
                  <field name="TRADE_EACH_TICK">FALSE</field>
                  <field name="TRADETYPECAT_LIST">callput</field>
                  <field name="TRADETYPE_LIST">put</field>
                  <value name="DURATION">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                  </value>
                  <value name="AMOUNT">
                    <shadow type="math_number">
                      <field name="NUM">6</field>
                    </shadow>
                    <block type="variables_get">
                      <field name="VAR" id="stake">stake</field>
                    </block>
                  </value>
                  <value name="PREDICTION">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                    <block type="math_number">
                      <field name="NUM">1</field>
                    </block>
                  </value>
                </block>
              </statement>
            </block>
          </statement>
        </block>
      </statement>
    </block>
    
    <block type="after_purchase" id="after_purchase_block" x="50" y="600">
      <statement name="AFTERPURCHASE_STACK">
        <block type="controls_if">
          <mutation else="1"></mutation>
          <value name="IF0">
            <block type="contract_check_result">
              <field name="CHECK_RESULT">win</field>
            </block>
          </value>
          <statement name="DO0">
            <!-- Win Handling -->
            <block type="variables_set">
              <field name="VAR" id="recovery_mode">recovery_mode</field>
              <value name="VALUE">
                <block type="logic_boolean">
                  <field name="BOOL">FALSE</field>
                </block>
              </value>
              <next>
                <block type="variables_set">
                  <field name="VAR" id="stake">stake</field>
                  <value name="VALUE">
                    <block type="variables_get">
                      <field name="VAR" id="initial_stake">initial_stake</field>
                    </block>
                  </value>
                </block>
              </next>
            </block>
          </statement>
          <statement name="ELSE">
            <!-- Loss Handling -->
            <block type="variables_set">
              <field name="VAR" id="stake">stake</field>
              <value name="VALUE">
                <block type="math_arithmetic">
                  <field name="OP">MULTIPLY</field>
                  <value name="A">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                    <block type="variables_get">
                      <field name="VAR" id="stake">stake</field>
                    </block>
                  </value>
                  <value name="B">
                    <shadow type="math_number">
                      <field name="NUM">1</field>
                    </shadow>
                    <block type="variables_get">
                      <field name="VAR" id="martingale">martingale</field>
                    </block>
                  </value>
                </block>
              </value>
              <next>
                <block type="variables_set">
                  <field name="VAR" id="recovery_mode">recovery_mode</field>
                  <value name="VALUE">
                    <block type="logic_boolean">
                      <field name="BOOL">TRUE</field>
                    </block>
                  </value>
                </block>
              </next>
            </block>
          </statement>
          <next>
            <!-- Check Profit/Loss Conditions -->
            <block type="controls_if">
              <mutation elseif="1" else="1"></mutation>
              <value name="IF0">
                <block type="logic_compare">
                  <field name="OP">GTE</field>
                  <value name="A">
                    <block type="total_profit"></block>
                  </value>
                  <value name="B">
                    <block type="variables_get">
                      <field name="VAR" id="take_profit">take_profit</field>
                    </block>
                  </value>
                </block>
              </value>
              <statement name="DO0">
                <!-- Take Profit Hit -->
                <block type="text_print">
                  <value name="TEXT">
                    <shadow type="text">
                      <field name="TEXT">ðŸŽ¯ TAKE PROFIT HIT! Stopping bot.</field>
                    </shadow>
                  </value>
                </block>
                <block type="controls_flow_statements">
                  <field name="FLOW">STOP</field>
                </block>
              </statement>
              <value name="IF1">
                <block type="logic_compare">
                  <field name="OP">LTE</field>
                  <value name="A">
                    <block type="total_profit"></block>
                  </value>
                  <value name="B">
                    <block type="math_single">
                      <field name="OP">NEG</field>
                      <value name="NUM">
                        <shadow type="math_number">
                          <field name="NUM">30</field>
                        </shadow>
                        <block type="variables_get">
                          <field name="VAR" id="stop_loss">stop_loss</field>
                        </block>
                      </value>
                    </block>
                  </value>
                </block>
              </value>
              <statement name="DO1">
                <!-- Stop Loss Hit -->
                <block type="text_print">
                  <value name="TEXT">
                    <shadow type="text">
                      <field name="TEXT">ðŸš« STOP LOSS HIT! Stopping bot.</field>
                    </shadow>
                  </value>
                </block>
                <block type="controls_flow_statements">
                  <field name="FLOW">STOP</field>
                </block>
              </statement>
              <statement name="ELSE">
                <!-- Continue Trading -->
                <block type="trade_again"></block>
              </statement>
            </block>
          </next>
        </block>
      </statement>
    </block>
  </blocks>

  <javascript>
<![CDATA[
// JavaScript section for advanced logic
// This code runs alongside the blockly logic

// Global variables accessible in both XML and JS
let botState = {
    totalTrades: 0,
    consecutiveWins: 0,
    consecutiveLosses: 0,
    maxLossStreak: 0,
    totalProfit: 0,
    isRunning: true
};

// Function to calculate safe stake based on balance
function calculateSafeStake(currentStake, balance) {
    // Don't risk more than 5% of balance on single trade
    const maxRisk = balance * 0.05;
    return Math.min(currentStake, maxRisk);
}

// Enhanced prediction algorithm
function enhancedPrediction(lastDigits) {
    if (lastDigits.length < 5) return 1;
    
    // Check for patterns in last digits
    const frequencies = {};
    lastDigits.forEach(digit => {
        frequencies[digit] = (frequencies[digit] || 0) + 1;
    });
    
    // Find most frequent digit
    let mostFrequent = 1;
    let maxCount = 0;
    for (const [digit, count] of Object.entries(frequencies)) {
        if (count > maxCount) {
            maxCount = count;
            mostFrequent = parseInt(digit);
        }
    }
    
    return mostFrequent;
}

// Risk management function
function shouldSkipTrade(currentStake, balance, consecutiveLosses) {
    // Skip if stake too high relative to balance
    if (currentStake > balance * 0.1) {
        console.log("Skipping trade: Stake too high relative to balance");
        return true;
    }
    
    // Skip after too many consecutive losses
    if (consecutiveLosses >= 5) {
        console.log("Skipping trade: Too many consecutive losses");
        return true;
    }
    
    return false;
}

// Logging function
function logTrade(result, stake, prediction) {
    const timestamp = new Date().toISOString();
    const logEntry = {
        timestamp: timestamp,
        result: result ? "WIN" : "LOSS",
        stake: stake,
        prediction: prediction,
        profit: result ? stake * 0.95 : -stake,
        totalProfit: botState.totalProfit
    };
    
    console.log("Trade Log:", JSON.stringify(logEntry));
    
    // Store in global variable for access in blocks
    Bot.setGlobal("last_trade_log", logEntry);
}

// Initialize bot when loaded
function initBot() {
    console.log("ðŸš€ Martingale Digits Bot Initialized");
    console.log("Version: 1.0");
    console.log("Strategy: Martingale with Recovery Mode");
    console.log("Symbol: R_50");
    console.log("Initial Stake: $6");
    console.log("Take Profit: $5");
    console.log("Stop Loss: $30");
    console.log("Martingale Multiplier: 2x");
    
    // Set initial global variables
    Bot.setGlobal("bot_initialized", true);
    Bot.setGlobal("start_time", new Date().toISOString());
    
    return true;
}

// Cleanup function when bot stops
function cleanupBot() {
    console.log("ðŸ¤– Bot Stopping - Final Report:");
    console.log("Total Trades:", botState.totalTrades);
    console.log("Total Profit:", botState.totalProfit.toFixed(2));
    console.log("Max Loss Streak:", botState.maxLossStreak);
    console.log("Final Status:", botState.totalProfit >= 0 ? "PROFIT" : "LOSS");
    
    Bot.setGlobal("bot_finished", true);
    Bot.setGlobal("end_time", new Date().toISOString());
}

// Call initialization on bot start
initBot();
]]>
  </javascript>

  <style>
    .bot-title {
      color: #4CAF50;
      font-size: 18px;
      font-weight: bold;
    }
    
    .profit-positive {
      color: #4CAF50;
    }
    
    .profit-negative {
      color: #F44336;
    }
    
    .warning {
      color: #FF9800;
    }
  </style>
</trade>
</binary>
